sequenceDiagram
  participant Writer
  participant TextInput
  participant ProdTriggers as useProdTriggers
  participant Rules as prodTriggerRules
  participant Settling as SettlingTimer
  participant Watchdog
  participant Queue as useProdQueueManager/onTrigger

  Writer->>TextInput: type, pause, resume
  TextInput->>ProdTriggers: { text, sentences, config }
  ProdTriggers->>Rules: shouldTriggerProd(lastSentence, cooldownMs)
  alt below cooldown or text too short
    Rules-->>ProdTriggers: false
    note over ProdTriggers: store last input time + keep timers disarmed
  else cleared to trigger
    Rules-->>ProdTriggers: true
    ProdTriggers->>Rules: getProdTriggerReason(lastTriggerCharPos)
    alt Terminal punctuation / soft comma / charTrigger reached
      Rules-->>ProdTriggers: reason
      note right of ProdTriggers: log âš™ reason & gate on prodsEnabled
      ProdTriggers->>Queue: onTrigger(fullText, lastSentence)
      Queue-->>Queue: enqueue request, dedupe fingerprints
    else No immediate reason
      ProdTriggers->>Settling: schedule config.settlingMs timer
      Settling-->>ProdTriggers: fire with latest text/sentences
      ProdTriggers->>Rules: shouldTriggerProd(...)
      Rules-->>ProdTriggers: true
      ProdTriggers->>Queue: trigger after settling
    end
  end

  Watchdog-->>ProdTriggers: idle >= WATCHDOG_IDLE_MS?
  alt Idle >= 6s & armed
    ProdTriggers->>Queue: trigger({ force: true })
    note over Queue,ProdTriggers: ensures chip after long pause
  else Still typing / watchdog disarmed
    note over Watchdog: keep checking every second
  end
