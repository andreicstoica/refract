sequenceDiagram
  participant Writer
  participant TextInput
  participant Topic as useTopicShiftDetection
  participant Triggers as useProdTriggers
  participant Actions as ProdsProvider/useProdActions
  participant Guards as useProdQueueManager
  participant API as /api/prod
  participant Chips as ChipOverlay

  Writer->>TextInput: type / pause / resume
  TextInput->>Topic: share latest text window
  Topic-->>Actions: updateTopicContext(keywords, topicVersion)
  alt topic shift detected
    Topic->>Actions: notifyTopicShift()
    Actions->>Guards: cancelAllRequests + clear queue + reset TTL maps
  end
  TextInput->>Triggers: { text, sentences, config }
  Triggers->>Triggers: shouldTriggerProd + getProdTriggerReason
  alt punctuation / char threshold satisfied
    Triggers->>Actions: enqueueSentence(fullText, lastSentence)
  else settle timer or watchdog
    Triggers->>Triggers: wait config.settlingMs or WATCHDOG_IDLE_MS
    Triggers->>Actions: enqueueSentence(..., force?)
  end
  Actions->>Guards: add queue item
  Guards->>Guards: apply shouldProcessSentence + TTL dedupe
  alt guardrails block sentence
    Note over Guards: short text / duplicate / queue full â†’ drop
  else sentence accepted
    Guards->>Guards: waitForRateLimit(config.rateLimitMs)
    Guards->>API: generateProdWithTimeout(lastParagraph, fullText, recentProds, topicKeywords)
    API-->>Guards: { selectedProd, confidence }
    alt topicVersion changed or low confidence
      Guards-->>Actions: discard queue item
    else result approved
      Guards->>Chips: append prod, prune non-pinned, cache normalized text
    end
  end
  Note over Triggers: Watchdog arms on each keystroke and fires force trigger after 6s idle
