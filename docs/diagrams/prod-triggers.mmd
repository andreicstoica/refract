sequenceDiagram
  participant Writer
  participant TextInput
  participant Topic as useTopicShiftDetection
  participant Triggers as useProdTriggers
  participant Rules as prodTriggerRules
  participant Actions as ProdsProvider/useProdActions
  participant Guards as useProdQueueManager
  participant API as /api/prod
  participant Chips as ChipOverlay

  Writer->>TextInput: type / pause / resume
  TextInput->>Topic: share latest text window
  
  Topic-->>Actions: updateTopicContext(keywords, topicVersion)
  
  alt topic shift detected
    Topic->>Actions: notifyTopicShift()
    Actions->>Guards: cancelAllRequests + clear queue + reset TTL maps
  end
  
  TextInput->>Triggers: { text, sentences, config }
  
  Triggers->>Rules: shouldTriggerProd(cooldown, min length)
  
  alt shouldTriggerProd returns false
    Note over Triggers: Cooldown active or text too short
  else shouldTriggerProd returns true
    Triggers->>Rules: getProdTriggerReason()
    
    alt immediate trigger (punctuation / comma / char threshold)
      Rules-->>Triggers: "punctuation" / "softComma" / "charThreshold"
      Triggers->>Actions: enqueueSentence(fullText, lastSentence)
    else no immediate trigger
      Triggers->>Triggers: scheduleSettlingTrigger(config.settlingMs)
      Note over Triggers: Wait for settling timer
      Triggers->>Rules: shouldTriggerProd (re-check)
      alt still valid after settling
        Triggers->>Actions: enqueueSentence(fullText, lastSentence)
      end
    end
  end
  
  Note over Triggers: Watchdog timer (6s idle) forces prod with force=true
  
  Actions->>Guards: enqueueSentence(fullText, sentence)
  
  Guards->>Guards: apply shouldProcessSentence + TTL dedupe
  
  alt guardrails block sentence
    Note over Guards: short text / duplicate / queue full â†’ drop
  else sentence accepted
    Guards->>Guards: waitForRateLimit(config.rateLimitMs)
    Guards->>API: generateProdWithTimeout(lastParagraph, recentText, recentProds, topicKeywords)
    API-->>Guards: { selectedProd, confidence }
    
    alt topicVersion changed or low confidence
      Guards->>Guards: COMPLETE_PROCESSING (discard)
    else result approved
      Guards->>Chips: append prod to array, cache normalized text
    end
  end
