sequenceDiagram
  box lightblue UI Layer
    participant Writer
    participant TextInput
    participant Chips as ChipOverlay
  end
  box lightgreen Hooks
    participant Topic as useTopicShiftDetection
    participant Triggers as useProdTriggers
  end
  box lightyellow Rules
    participant Rules as prodTriggerRules
  end
  box plum Providers
    participant Actions as ProdsProvider/useProdActions
  end
  box wheat Queue/Guards
    participant Guards as useProdQueueManager
  end
  box lightpink API
    participant API as /api/prod
  end

  Writer->>TextInput: type / pause / resume
  TextInput->>Topic: share latest text window
  
  Topic-->>Actions: updateTopicContext(keywords, topicVersion)
  
  alt topic shift detected
    Topic->>Actions: notifyTopicShift()
    Actions->>Guards: cancelAllRequests + clear queue + reset TTL maps
  end
  
  TextInput->>Triggers: { text, sentences, config }
  Note over TextInput,Triggers: Sentences split on punctuation and newlines
  
  Triggers->>Rules: shouldTriggerProd(cooldown, min length)
  
  alt shouldTriggerProd returns false
    Note over Triggers: Cooldown active or text too short
  else shouldTriggerProd returns true
    Triggers->>Rules: getProdTriggerReason()
    
    alt immediate trigger (punctuation / comma / char threshold)
      Rules-->>Triggers: "punctuation" / "softComma" / "charThreshold"
      Triggers->>Actions: enqueueSentence(fullText, lastSentence)
    else no immediate trigger
      Triggers->>Triggers: scheduleSettlingTrigger(config.settlingMs)
      Note over Triggers: Wait for settling timer
      Triggers->>Rules: shouldTriggerProd (re-check)
      alt still valid after settling
        Triggers->>Actions: enqueueSentence(fullText, lastSentence)
      end
    end
  end
  
  Note over Triggers: Watchdog timer (6s idle) forces prod with force=true
  
  Actions->>Guards: enqueueSentence(fullText, sentence)
  
  Guards->>Guards: resolved = resolveLatestSentence(fullText, sentence)
  Guards->>Guards: apply shouldProcessSentence + sentence.id guard (15s/60s) + display TTL (30s/120s)
  
  alt guardrails block sentence
    Note over Guards: short text / duplicate / queue full â†’ drop
  else sentence accepted
    Guards->>Guards: waitForRateLimit(config.rateLimitMs)
    Guards->>API: generateProdWithTimeout(lastParagraph, recentText, recentProds, topicKeywords)
    API-->>Guards: { selectedProd, confidence }
    
    alt topicVersion changed or low confidence
      Guards->>Guards: COMPLETE_PROCESSING (discard)
    else result approved
      Guards->>Chips: append prod to array, cache normalized text
    end
  end
