flowchart TB
  classDef client fill:#dbeafe,stroke:#3b82f6,stroke-width:2px
  classDef api fill:#dcfce7,stroke:#22c55e,stroke-width:2px
  classDef service fill:#fef3c7,stroke:#f59e0b,stroke-width:2px

  subgraph Client["Theme Analysis / Embeddings Consumer"]
    direction TB
    ThemeAnalysis["useThemeAnalysis / EmbeddingsProvider"]
    RunAnalysis["runEmbeddingsAnalysis (client)"]
    EmbeddingsClient["generateEmbeddings() client"]
  end

  subgraph API["/api/embeddings route"]
    direction TB
    Request["POST /api/embeddings"]
    Chunking["sentencesToChunks()"]
    EmbeddingService["generateEmbeddingVectors()"]
    Clustering["clusterEmbeddings()"]
    ThemeService["generateThemesForClusters()"]
    Enrichment["enrichClustersWithThemes()"]
    Filtering["selectTopClusters()"]
    Formatter["formatClustersForResponse()"]
  end

  ThemeAnalysis --> RunAnalysis --> EmbeddingsClient --> Request
  Request --> Chunking --> EmbeddingService --> Clustering
  Clustering --> ThemeService --> Enrichment --> Filtering --> Formatter
  Formatter --> Response["clusters + themes payload"]

  Formatter -->|stored| Storage["storage.setThemes / setSentences"]:::service
  Request -.->|debug| Log["debug.dev logs"]:::service

  class ThemeAnalysis,RunAnalysis,EmbeddingsClient client
  class Request,Chunking,EmbeddingService,Clustering,ThemeService,Enrichment,Filtering,Formatter api
  class Storage,Log service
