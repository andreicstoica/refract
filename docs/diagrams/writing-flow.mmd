flowchart TD
  subgraph AppShell["App Shell (app/layout.tsx)"]
    direction TB
    ThemeProvider
    TimingConfigProvider
    EmbeddingsProvider
  end

  subgraph PageLevel["Write Page (app/write/page.tsx)"]
    direction TB
    
    subgraph ProdsProvider["ProdsProvider (wraps TextInput)"]
      direction TB
      
      subgraph Editor["TextInput Component"]
        direction TB
        useEditorText["useEditorText<br/>(text, ref, metrics)"]
        TopicShift["useTopicShiftDetection<br/>(keywords, topicVersion)"]
        useSentenceTracker["useSentenceTracker<br/>(sentences, positions)"]
        useProdTriggers["useProdTriggers<br/>(timers, heuristics, watchdog)"]
        
        useEditorText --> TopicShift
        useEditorText --> useSentenceTracker
        useSentenceTracker --> useProdTriggers
      end
      
      subgraph ProdsStack["useProdQueueManager"]
        direction TB
        ProdActions["useProdActions<br/>(enqueue, updateTopicContext, notifyTopicShift)"]
        QueueManager["Queue Manager<br/>(guardrails, dedupe, rate limit)"]
        ProdState["prods[], pinnedIds,<br/>filteredSentences"]
        
        ProdActions --> QueueManager
        QueueManager --> ProdState
      end
      
      Editor --> ProdsStack
    end
    
    subgraph Overlays["UI Overlays"]
      direction TB
      ChipOverlay
      HighlightOverlay
    end
  end

  AppShell --> PageLevel
  
  TopicShift -->|updateTopicContext| ProdActions
  TopicShift -.->|notifyTopicShift<br/>(on shift)| ProdActions
  useProdTriggers -->|enqueueSentence| ProdActions
  
  TimingConfigProvider --> useProdTriggers
  TimingConfigProvider --> QueueManager
  
  ProdState --> ChipOverlay
  ProdState --> HighlightOverlay
  
  ChipOverlay --> TextArea["Textarea DOM"]
  HighlightOverlay --> TextArea
  
  ThemeProvider --> HighlightOverlay
  EmbeddingsProvider --> Editor
