stateDiagram-v2
  [*] --> Idle
  
  Idle --> Pending : enqueueSentence<br/>(after filters)
  
  Pending --> Idle : guardrail drop /<br/>queue trimmed
  Pending --> Processing : START_PROCESSING<br/>(waitForRateLimit)
  
  Processing --> Idle : COMPLETE_PROCESSING<br/>(API success + confidence ok)
  Processing --> Idle : COMPLETE_PROCESSING<br/>(topicVersion mismatch / cancelled)
  Processing --> Idle : FAIL_PROCESSING<br/>(timeout / network error)
  Processing --> Idle : COMPLETE_PROCESSING<br/>(low confidence)
  
  note right of Pending
    Deduplication checks:
    - Normalized text TTL
    - Fingerprint TTL
    - Recent sentence text map
    - Queue size cap (3 prod / 5 demo)
  end note
  
  note right of Processing
    Parallel processing:
    - 2 slots on /write
    - 3 slots on /demo
    - Pulls newest pending items
  end note
  
  Idle --> TopicReset : notifyTopicShift
  TopicReset --> Idle : cancelAllRequests +<br/>clear queue +<br/>reset TTL maps
  
  note right of TopicReset
    On topic shift:
    - Cancel all ongoing requests
    - Clear pending queue
    - Reset fingerprint maps
    - Keep pinned prods
  end note

  state ProdsArray["Prods Array (separate from queue)"]
    [*] --> Active
    Active --> Pinned : pinProd(id)
    Pinned --> Active : removeProd(id)
    Active --> [*] : removeProd(id)
    Pinned --> [*] : removeProd(id)
    
    note right of ProdsArray
      Prods live in separate array
      after queue processing completes.
      Pinning is independent of queue state.
    end note
  end
