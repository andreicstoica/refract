flowchart TB
  classDef note fill:#fef3c7,color:#78350f,stroke:#fbbf24,font-size:12px;

  subgraph QueueLoop [QueueLoop]
    direction TB
    Idle[[Idle]]
    Pending[[Pending]]
    Processing[[Processing]]
  end

  TopicReset[[TopicReset]]

  Entry((Entry)) --> Idle
  Idle -->|ENQUEUE<br>_| Pending
  Pending -->|COMPLETE_PROCESSING<br>queue trimmed| Idle
  Pending -->|START_PROCESSING<br>waitForRateLimit| Processing
  Processing -->|COMPLETE_PROCESSING<br>API success + confidence ok| Idle
  Processing -->|COMPLETE_PROCESSING<br>topicVersion mismatch / cancelled| Idle
  Processing -->|FAIL_PROCESSING<br>timeout / network error| Idle
  Processing -->|COMPLETE_PROCESSING<br>low confidence| Idle
  Idle -->|notifyTopicShift| TopicReset
  TopicReset -->|cancelAllRequests +<br>clear queue +<br>reset guard maps| Idle
  Processing -.->|success creates| ProdsActive

  linkStyle 0 stroke:#475569,stroke-width:1.5px,stroke-dasharray:5 4;
  linkStyle 1 stroke:#2563eb,stroke-width:2.2px;
  linkStyle 2 stroke:#c2410c,stroke-width:2.2px;
  linkStyle 3 stroke:#2563eb,stroke-width:2.2px;
  linkStyle 4 stroke:#c2410c,stroke-width:2.2px;
  linkStyle 5 stroke:#c2410c,stroke-width:2.2px;
  linkStyle 6 stroke:#c2410c,stroke-width:2.2px;
  linkStyle 7 stroke:#c2410c,stroke-width:2.2px;
  linkStyle 8 stroke:#2563eb,stroke-width:2.2px;
  linkStyle 9 stroke:#c2410c,stroke-width:2.2px;
  linkStyle 10 stroke:#10b981,stroke-width:2px,stroke-dasharray:5 4;

  Pending -.-> PendingNote["Dedup + queue controls:<br>- Enqueue guard (sentence ID, 15s/60s) → blocks duplicate queue entries<br>- Display guard (normalized text, 30s/120s) → blocks duplicate visible prods<br>- Trim write queue to newest 3 entries & demo queue to newest 5 entries<br>- Drop oldest before dispatch"]:::note
  
  Processing -.-> ProcessingNote["Parallel processing:<br>- Concurrency cap 2 on /write<br>- Concurrency cap 3 on /demo<br>- Pull newest pending items (LIFO)<br>- Respects queue trims"]:::note
  
  TopicReset -.-> TopicNote["On topic shift:<br>- Cancel all ongoing requests<br>- Clear pending queue<br>- Reset guard maps<br>- Keep pinned prods"]:::note

  subgraph ProdsArray ["Prods Array (lives outside queue)"]
    direction TB
    ProdsActive[[Active]]
    ProdsPinned[[Pinned]]
    ProdsActive -->|pinProd| ProdsPinned
    ProdsPinned -->|unpin| ProdsActive
    ProdsActive -->|remove| ProdsEnd((Removed))
    ProdsPinned -->|remove| ProdsEnd
  end
